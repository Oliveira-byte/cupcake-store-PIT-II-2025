<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Admin - Pedidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .badge-status { background: #f38fb5; }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-light shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand" href="index.html">üßÅ Cupcake Store</a>
      <span class="text-muted">√Årea administrativa</span>
    </div>
  </nav>

  <div class="container mb-4">
    <h1 class="mb-3">üìã Pedidos recebidos</h1>
    <p class="text-muted">Visualize e atualize o status dos pedidos feitos pelo site.</p>

    <!-- token -->
    <div class="row g-2 mb-3">
      <div class="col-md-3">
        <label class="form-label mb-0">Token</label>
        <input type="text" id="token" class="form-control" value="admin123">
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="carregarPedidos()">üîÑ Carregar pedidos</button>
      </div>
      <div class="col-md-6 d-flex flex-column">
        <label class="form-label mb-0">Filtrar (cliente, e-mail, status, observa√ß√µes...)</label>
        <input type="text" id="filtro" class="form-control" placeholder="digite para filtrar" oninput="aplicarFiltro()">
      </div>
    </div>

    <!-- tabela -->
    <div id="lista-pedidos" class="table-responsive">
      <p>Nenhum pedido carregado.</p>
    </div>

    <!-- pagina√ß√£o -->
    <div class="d-flex justify-content-between align-items-center mt-3" id="paginacao" style="display:none;">
      <button class="btn btn-outline-secondary btn-sm" onclick="paginaAnterior()">¬´ Anterior</button>
      <span id="info-pagina" class="text-muted small"></span>
      <button class="btn btn-outline-secondary btn-sm" onclick="proximaPagina()">Pr√≥xima ¬ª</button>
    </div>
  </div>

  <!-- modal de itens -->
  <div class="modal fade" id="modalItens" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Itens do pedido</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="corpo-itens">
          Carregando...
        </div>
      </div>
    </div>
  </div>

  <footer class="py-4 bg-light text-center mt-4">
    <p class="mb-0">Danilo Ferreira de Oliveira ‚Äì PIT II - Engenharia de Software ‚Ä¢ 2025 ‚Äì √Årea administrativa</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = "http://127.0.0.1:5000";

    // estado
    let todosPedidos = [];     // tudo que veio do back
    let pedidosFiltrados = []; // depois do filtro
    let paginaAtual = 1;
    const tamanhoPagina = 5;  

    function carregarPedidos() {
      const token = document.getElementById('token').value;
      fetch(`${API_BASE}/pedidos?token=${token}`)
        .then(r => r.json())
        .then(lista => {
          if (lista.error) {
            document.getElementById('lista-pedidos').innerHTML =
              `<div class="alert alert-danger">${lista.error}</div>`;
            return;
          }
          todosPedidos = lista;
          pedidosFiltrados = lista; // come√ßa sem filtro
          paginaAtual = 1;
          renderTabela();
          atualizarPaginacao();
        })
        .catch(err => {
          console.error(err);
          document.getElementById('lista-pedidos').innerHTML =
            "<div class='alert alert-danger'>Erro ao carregar pedidos.</div>";
        });
    }

    function aplicarFiltro() {
      const termo = document.getElementById('filtro').value.toLowerCase();
      if (!termo) {
        pedidosFiltrados = todosPedidos;
      } else {
        pedidosFiltrados = todosPedidos.filter(p => {
          return (
            (p.cliente_nome || "").toLowerCase().includes(termo) ||
            (p.cliente_email || "").toLowerCase().includes(termo) ||
            (p.cliente_telefone || "").toLowerCase().includes(termo) ||
            (p.observacoes || "").toLowerCase().includes(termo) ||
            (p.status || "").toLowerCase().includes(termo)
          );
        });
      }
      paginaAtual = 1;
      renderTabela();
      atualizarPaginacao();
    }

    function renderTabela() {
      const div = document.getElementById('lista-pedidos');

      if (!pedidosFiltrados.length) {
        div.innerHTML = "<p>Nenhum pedido encontrado.</p>";
        return;
      }

      // c√°lculo da pagina√ß√£o
      const inicio = (paginaAtual - 1) * tamanhoPagina;
      const fim = inicio + tamanhoPagina;
      const pagina = pedidosFiltrados.slice(inicio, fim);

      let html = `
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Cliente</th>
              <th>Data</th>
              <th>Observa√ß√µes</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
      `;

      pagina.forEach(p => {
        html += `
          <tr>
            <td>${p.id_pedido}</td>
            <td>
              <strong>${p.cliente_nome || "‚Äî"}</strong><br>
              <small>${p.cliente_email || ""} ${p.cliente_telefone || ""}</small>
            </td>
            <td>${p.data_pedido || ""}</td>
            <td><small>${p.observacoes || ""}</small></td>
            <td><span class="badge badge-status" id="status-${p.id_pedido}">${p.status}</span></td>
            <td>
              <select class="form-select form-select-sm mb-2" onchange="alterarStatus(${p.id_pedido}, this.value)">
                <option value="">Alterar status...</option>
                <option value="novo">novo</option>
                <option value="em andamento">em andamento</option>
                <option value="atendido">atendido</option>
              </select>
              <button class="btn btn-sm btn-outline-primary w-100" onclick="verItens(${p.id_pedido})">Ver itens</button>
            </td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      div.innerHTML = html;
    }

    function atualizarPaginacao() {
      const totalRegistros = pedidosFiltrados.length;
      const totalPaginas = Math.ceil(totalRegistros / tamanhoPagina);
      const pagDiv = document.getElementById('paginacao');

      if (totalPaginas <= 1) {
        pagDiv.style.display = 'none';
        return;
      }

      pagDiv.style.display = 'flex';
      document.getElementById('info-pagina').textContent =
        `P√°gina ${paginaAtual} de ${totalPaginas} (${totalRegistros} pedidos)`;
    }

    function paginaAnterior() {
      if (paginaAtual > 1) {
        paginaAtual--;
        renderTabela();
        atualizarPaginacao();
      }
    }

    function proximaPagina() {
      const totalPaginas = Math.ceil(pedidosFiltrados.length / tamanhoPagina);
      if (paginaAtual < totalPaginas) {
        paginaAtual++;
        renderTabela();
        atualizarPaginacao();
      }
    }

    function alterarStatus(idPedido, novoStatus) {
      if (!novoStatus) return;
      const token = document.getElementById('token').value;

      fetch(`${API_BASE}/pedidos/${idPedido}/status?token=${token}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ status: novoStatus })
      })
      .then(r => r.json())
      .then(resp => {
        if (resp.error) {
          alert("Erro: " + resp.error);
          return;
        }
        const badge = document.getElementById(`status-${idPedido}`);
        if (badge) badge.textContent = novoStatus;

        // atualiza o objeto na mem√≥ria 
        const pedido = todosPedidos.find(p => p.id_pedido === idPedido);
        if (pedido) pedido.status = novoStatus;
        const pedidoFiltrado = pedidosFiltrados.find(p => p.id_pedido === idPedido);
        if (pedidoFiltrado) pedidoFiltrado.status = novoStatus;
      })
      .catch(err => {
        console.error(err);
        alert("N√£o foi poss√≠vel atualizar o status.");
      });
    }

    function verItens(idPedido) {
      const token = document.getElementById('token').value;
      fetch(`${API_BASE}/pedidos/${idPedido}/itens?token=${token}`)
        .then(r => r.json())
        .then(lista => {
          const corpo = document.getElementById('corpo-itens');
          if (!lista.length) {
            corpo.innerHTML = "<p>Pedido sem itens (provavelmente veio do formul√°rio de encomenda).</p>";
          } else {
            let html = "<ul class='list-group'>";
            lista.forEach(i => {
              html += `
                <li class='list-group-item d-flex justify-content-between align-items-center'>
                  ${i.produto_nome} (x${i.quantidade})
                  <span>R$ ${i.preco_unitario}</span>
                </li>
              `;
            });
            html += "</ul>";
            corpo.innerHTML = html;
          }
          const modal = new bootstrap.Modal(document.getElementById('modalItens'));
          modal.show();
        });
    }
  </script>
</body>
</html>
